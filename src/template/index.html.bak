<html>

<head>
    <title>Bundled StoryMapJS test page</title>
    <!-- this is normally done by embed page -->

    <script>
        function ready(fn) {
            if (document.readyState != 'loading') {
                fn();
            } else {
                document.addEventListener('DOMContentLoaded', fn);
            }
        }

        ready(function() {
            console.log('ready function');
		    var options = {
		        script_path: '/dist/js/storymap.js',
		        start_at_slide: 0
		    };
		    var storymap = null;
		    var params = parseQuerystring();
		    var storymap_url = decodeURIComponent(params['url']);
            if(!!navigator.userAgent.match(/AppleWebKit\/.* Mobile\//)
            || !!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/)
            || !!navigator.userAgent.toLowerCase().match(/msie [789]/)) {
                if(storymap_url.match(/^https?:\/\/www\.googledrive\.com\/host\//)) {
                    storymap_url = location.protocol+'//proxy.knightlab.com/'+storymap_url.split('://')[1];
                    //trace('proxy, '+storymap_url);
                }
            }
		    if(params.hasOwnProperty('start_at_slide')) {
		        options.start_at_slide = parseInt(params.start_at_slide);
		    }

            /* was onload function */
		    if(storymap_url.match('\\.js$')) {
		        //trace('embed: loading data via script injection');
		        var loaded = false;
		        var script = document.createElement("script");
		        script.type = "text/javascript";
		        script.src  = storymap_url;
		        script.onload = script.onreadystatechange = function() {
		            if(!loaded && (!(d = this.readyState) || d == "loaded" || d == "complete")) {
		                loaded = true;
		                storymap_onload(storymap_json);
		            }
		        }
		        // document.head not standard before HTML5
		        var insertionPoint = document.head || document.getElementsByTagName('head').item(0) || document.documentElement.childNodes[0];
		        insertionPoint.appendChild(script);
		    } else {
		        storymap_getjson();
		    }
        });

		function parseQuerystring() {
		    var nvpair = {};
		    var qs = window.location.search.replace('?', '');
		    var pairs = qs.split('&');
		    for(var i = 0; i < pairs.length; i++) {
		        var p = pairs[i].split('=');
		        nvpair[p[0]] = p[1];
		    }
		    return nvpair;
		}

		function storymap_onload(d) {
		    //trace('embed: storymap data loaded');
            console.log('storymap_onload');
		    if (d && d.storymap) {
		        var font = "stock:default";
		        if(d.font_css) {
		            font = d.font_css;
		        }
		        if(font.indexOf("stock:") == 0) {
		            var font_name = font.split(':')[1];
		            var base_url = url_join(options.script_path,"../css/fonts");
		            font = url_join(base_url, "font." + font_name + ".css");
		        } else if(!font.match('^(http|https|//)')) {
		            font = url_join(options.script_path, font);
		        }
		        //VCO.Load.css(font,function(){ /*trace('font loaded: ' + font);  */ });
		        storymap = new KLStoryMap.StoryMap('storymap-embed', d, options, {title: on_storymap_title});
		    }
            var mapType = storymap.options.map_type;
            if(mapType && mapType.match('^zoomify.*')) {
                ga('send', 'event', 'StoryMapJS', 'zoomify', document.referrer)
            }
		}

		function on_storymap_title(e) {
			document.title = "StoryMapJS: " + e.title;
		};

		function storymap_getjson() {
            console.log('storymap_getjson');
		    if('withCredentials' in new XMLHttpRequest()) {
                console.log('with credentials');
		        // Supports cross-domain requests
		        //trace('embed: loading data via XMLHttpRequest');
		        KLStoryMap.getJSON(storymap_url, storymap_onload);
		    } else if(typeof XDomainRequest !== "undefined") {
		        // Use IE-specific "CORS" code with XDR
		        //trace('embed: loading data via XDomainRequest');
		        var xdr = new XDomainRequest();
		        xdr.onload = function() {
		            storymap_onload(JSON.parse(xdr.responseText));
		        };
		        xdr.onerror = function() {
		            //trace('embed: error loading data via XDomainRequest');
		        };
		        xdr.onprogress = function() {};
		        xdr.open("get", storymap_url);
		        xdr.send();
		    }
		}

        /*
		window.onload = function() {
		    if(storymap_url.match('\\.js$')) {
		        //trace('embed: loading data via script injection');
		        var loaded = false;
		        var script = document.createElement("script");
		        script.type = "text/javascript";
		        script.src  = storymap_url;
		        script.onload = script.onreadystatechange = function() {
		            if(!loaded && (!(d = this.readyState) || d == "loaded" || d == "complete")) {
		                loaded = true;
		                storymap_onload(storymap_json);
		            }
		        }
		        // document.head not standard before HTML5
		        var insertionPoint = document.head || document.getElementsByTagName('head').item(0) || document.documentElement.childNodes[0];
		        insertionPoint.appendChild(script);
		    } else {
		        storymap_getjson();
		    }
		}
        */

		window.onresize = function(event) {
		    if(storymap) {
		        storymap.updateDisplay();
		    }
		}
    </script>

	<style>
		html, body {
		    width: 100%;
		    height: 100%;
		    padding: 0;
		    margin: 0;
		}
		#storymap-embed {
			/*border: 1px solid #999;*/
		}
	</style>

</head>

<body>
    <h1>StoryMap Development</h1>
    <div>
        <label for="timeline-src">data source URL:</label><input type="text" size="120" name="timeline-src" id="timeline-src">
    </div>
    <div id='storymap-embed'></div>
</body>

</html>
